# Complex Twin Polycrystal Generator

这是一个基于 **Atomsk** 的自动化脚本工具，用于生成包含复杂内部孪晶结构的多晶模型。该工具专为模拟高熵合金或金属材料（如 Cu, Al）的微观结构而设计，支持高度自定义的孪晶间距控制。

## 1. 核心功能

*   **自动化多晶生成**：基于 Voronoi 泰森多边形法生成多晶结构。
*   **复杂内部孪晶**：每个晶粒内部不再是单一晶向，而是包含平行排列的孪晶层（Twin Lamellae）。
*   **灵活的间距控制**：支持三种孪晶生成模式：
    1.  **Random (随机)**：孪晶层和基体层的厚度在指定范围内随机变化。
    2.  **Equal (等间距)**：生成规则的、等厚度的孪晶结构。
    3.  **Ratio (比例)**：根据设定的体积百分比（如 30% 孪晶）自动分配层厚度。
    4.  **GNT (梯度孪晶)**：晶粒内部孪晶间距沿 Y 轴呈梯度变化，所有晶粒取向一致。
    5.  **NT (均匀孪晶)**：所有晶粒内部孪晶间距均匀且相同，所有晶粒取向一致。
    6.  **all_Equal (一致间距)**：所有晶粒内部孪晶间距相同（可分别设置 Matrix/Twin 厚度），但晶粒取向随机。
*   **自动时间戳存档**：每次运行会自动创建一个带时间戳的新文件夹，防止覆盖旧数据。
*   **内存优化**：针对 Atomsk 的内存限制进行了优化，确保能生成包含数百万原子的大型结构。

## 2. 建模原理

该工具的生成流程遵循以下步骤（模拟实验中的“自下而上”构建）：

1.  **创建基体单元 (Matrix Unit)**：
    *   构建一个 FCC 晶胞，取向设定为 `X=[11-2], Y=[111], Z=[-110]`（以 Cu/Al 为例）。
    *   Y 轴 (`[111]`) 被选为堆垛方向（Stacking Axis）。

2.  **创建孪晶单元 (Twin Unit)**：
    *   将基体单元沿堆垛面（Y=0）进行镜像（Mirror），生成孪晶取向的晶胞。

3.  **构建层状种子 (Layered Seed)**：
    *   根据配置文件中的模式（随机/等间距/比例），生成一个层厚度序列（例如：`[3层Matrix, 2层Twin, 5层Matrix...]`）。
    *   使用 `atomsk -duplicate` 命令将基体和孪晶单元沿 Y 轴复制对应次数。
    *   使用 `atomsk --merge Y` 将所有层堆叠在一起，形成一个细长的“层状种子柱”。

4.  **生成多晶 (Polycrystal Generation)**：
    *   使用 `atomsk --polycrystal` 命令。
    *   Atomsk 会在空间中随机撒点（Voronoi 节点），并将上述“层状种子”放置在每个节点上。
    *   **关键点**：Atomsk 会随机旋转这个种子以形成不同的晶粒取向。由于种子本身内部已经有了孪晶结构，因此旋转后的每个晶粒都会带有不同方向的孪晶条纹。

## 3. 使用方法

### 3.1 环境要求
*   Python 3.x
*   **Atomsk** (必须已安装并添加到系统 PATH 环境变量中)

### 3.2 运行
直接运行 `main.py`：

```bash
python main.py
```

程序运行结束后，会在当前目录下生成一个新的文件夹（例如 `output_project_v2_20231027_103000`），其中包含：
*   `poly.lmp`: 最终的 LAMMPS 数据文件。
*   `seed_layered.xsf`: 生成的层状种子文件（可用于检查孪晶间距）。
*   `log_*.txt`: 各个步骤的运行日志。

### 3.3 参数配置 (`setting.py`)

所有参数均在 `setting.py` 中修改，无需改动代码。

**常用参数：**

```python
class Config:
    # 材料
    ELEMENT = "Cu"
    LATTICE_A = 3.615
    
    # 模式选择: 'random', 'equal', 'ratio'
    TWIN_MODE = 'random' 
    
    # 模式1: 随机间距参数
    RANDOM_MIN_LAYERS = 2   # 最小层厚 (单位: 晶胞数)
    RANDOM_MAX_LAYERS = 8   # 最大层厚
    RANDOM_LAYER_COUNT = 6  # 种子中包含多少层 (层数越多，晶粒内的条纹越多)
    
    # 模式3: 比例控制参数
    RATIO_TWIN_FRACTION = 0.3 # 孪晶占比 30%
    
    # 多晶盒子尺寸 (埃)
    POLY_BOX = [600.0, 400.0, 200.0]
    
    # 晶粒数量
    POLY_GRAINS = 50
```

## 4. 常见问题 (FAQ)

**Q: 为什么生成的原子数过多/内存溢出？**
A: 请检查 `POLY_BOX` 是否过大，或者 `RANDOM_LAYER_COUNT` 是否过多。Atomsk 在生成多晶时，如果种子文件过大（特别是 X/Z 方向尺寸大），会消耗大量内存。本脚本已优化将 X/Z 设为 1 以节省内存，但如果 Y 方向（层数）极多，仍可能导致计算缓慢。

**Q: 如何改变晶粒取向？**
A: 晶粒取向是随机生成的（Voronoi 算法特性）。如果需要特定的织构，需要修改代码中生成 `poly.txt` 的部分，手动指定 node 的旋转角度。

**Q: 为什么看到的孪晶条纹方向各不相同？**
A: 这正是多晶的特性。每个晶粒都有随机的三维旋转，因此其内部固定的孪晶层也会随之旋转，呈现出不同角度的条纹。
